<!DOCTYPE html>
<html lang="fa">
<head>
  <title>نقشه محصولات</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" integrity="sha384-nU14brUcp6StFntEOOEBvcJm4huWjB0OcIeQ3fltAfSmuZFrkAif0T+UtNGlKKQv" crossorigin="anonymous">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- jQuery (for autocomplete) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery UI (for autocomplete) -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 80%;
    }
    /* Optional: Adjust the padding and margin as needed */
    #city-selector {
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
        width: 100%; /* یا هر عرضی که می‌خواهید */
        max-width: 300px; /* تنظیم حداکثر عرض */
      }
      #load-button {
        padding: 10px 20px;
        background-color: #4CAF50; /* رنگ پس‌زمینه */
        color: white; /* رنگ متن */
        border: none; /* حذف حاشیه */
        cursor: pointer; /* تغییر شکل نشانگر ماوس */
        font-size: 16px; /* اندازه فونت */
        border-radius: 5px; /* گوشه‌های گرد */
      }
      
      #load-button:hover {
        background-color: #367c39; /* رنگ پس‌زمینه تیره‌تر در حالت هاور */
      }
      
      #load-button:active {
        background-color: #245126; /* رنگ پس‌زمینه تیره‌تر در حالت فعال */
      }
    #search-box {
      padding: 10px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    #product-list {
      list-style: none;
      padding: 0;
    }
    #product-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .product-item {
      margin-left: 20px;
      font-size: smaller;
    }
    /* Added for better responsiveness */
    @media (max-width: 768px) {
      #map {
        height: 60%;
      }
    }
	
	@media (max-width: 768px) {
  #map {
    height: 300px; // ارتفاع ثابت به جای درصدی
    margin-bottom: 20px;
  }
  .col-md-8, .col-md-4 {
    width: 100%; // عرض کامل در موبایل
  }
}

	body {
		direction: rtl;
		font-family: "Vazirmatn", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
	}

	.accordion-button::after {
		margin-left: 0;
		margin-right: auto;
	}

	.product-item {
		margin-right: 20px;
		margin-left: 0;
		text-align: right;
	}

	#search-box, #city-selector, .accordion-button {
		text-align: right;
	}

	.leaflet-popup-content {
		text-align: right;
		direction: rtl;
	}
	
	

  </style>
</head>
<body class="text-right">

  <div class="container">
  <div class="row">
  <div class="col-12">
    <div class="alert alert-info" role="alert">
      <p>دیتا به زودی تکمیل‌تر خواهد شد.</p>
      <hr>
      <p class="mb-0">آخرین آپدیت : ۱۴ دی ۱۴۰۳</p>
    </div>
  </div>
</div>


    <div class="row">
      <div class="col-12">
        <h1 class="text-center my-4">نقشه محصولات</h1>
      </div>
    </div>
    <div class="row">
	  <div class="col-12 col-md-8 mb-3">
		<div class="row">
		  <div class="col-12 col-md-6 mb-3">
			<h5 class="text-center">شهر مورد نظر خود را انتخاب کنید</h5>
			<div class="d-flex gap-2">
			  <input type="text" id="city-selector" class="form-control" placeholder="انتخاب شهر...">
			  <button id="load-button" class="btn">بارگذاری شهر</button>
			</div>
		  </div>
		  <div class="col-12 col-md-6 mb-3">
			<h5 class="text-center">جستجوی محصول</h5>
			<input type="text" id="search-box" class="form-control" placeholder="جستجوی محصول...">
		  </div>
		</div>
		<div id="map"></div>
	  </div>
	  <div class="col-12 col-md-4">
		<div class="accordion" id="product-list"></div>
	  </div>
	</div>
    <div class="row mt-3">
      <div class="col-md-8">
        <div id="map"></div>
      </div>
      <div class="col-md-4">
		  <div class="accordion" id="product-list">
		  </div>
		</div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script>
    // Initialize the map
    var map = L.map('map'); // Tehran

    // Add a tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      subdomains: ['a', 'b', 'c']
    }).addTo(map);

    // Markers array to store markers
    var markers = [];

    // Function to add markers to the map
    function addMarkers(supermarkets) {
      // Clear existing markers
      markers.forEach(function(marker) {
        map.removeLayer(marker);
      });
      markers = [];

      // Add new markers
      supermarkets.forEach(function(supermarket) {
        var marker = L.marker([supermarket.lat, supermarket.lng]).addTo(map)
          .bindPopup(supermarket.supermarket_name);
        markers.push(marker);
      });
      
      // Zoom to the first marker if available
      if (markers.length > 0) {
        map.setView(markers[0].getLatLng(), 13);
      }
    }

    // Function to update the product list
    function updateProductList(supermarkets) {
	  var productList = document.getElementById('product-list');
	  productList.innerHTML = '';

	  supermarkets.forEach(function(supermarket, index) {
		var li = document.createElement('div');
		li.classList.add('accordion-item');
		
		li.innerHTML = `
		  <h2 class="accordion-header">
			<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
			  ${supermarket.supermarket_name}
			</button>
		  </h2>
		  <div id="collapse${index}" class="accordion-collapse collapse">
			<div class="accordion-body">
			  <ul class="list-group list-group-flush">
				${supermarket.products.map(product => 
				  `<li class="list-group-item product-item">${product}</li>`
				).join('')}
			  </ul>
			</div>
		  </div>
		`;
		
		productList.appendChild(li);
	  });
	}

    // List of cities with Persian names and English file names
    const cities = {
        "تهران": "tehran",
        "مشهد": "mashhad",
        "اصفهان": "esfahan",
        "شیراز": "shiraz",
        "تبریز": "tabriz",
        "قم": "qom",
        "اهواز": "ahvaz",
        "ارومیه": "urmia",
        "رشت": "rasht",
        "قزوین": "qazvin",
        "یزد": "yazd",
        "کرمان": "kerman",
        "همدان": "hamedan",
        "اردبیل": "ardabil",
        "گرگان": "gorgan",
        "ساری": "sari",
        "کرمانشاه": "kermanshah",
        "اسلامشهر": "eslamshahr",
        "اراک": "arak",
        "بوشهر": "boshehr",
        "بندرعباس": "bandarabbas",
        "بجنورد": "bojnord",
        "نیشابور": "nishapur",
        "شاهین شهر": "shahinshahr",
        "لاهیجان": "lahijan",
        "بابل": "babol",
        "پاکدشت": "pakdasht",
        "دزفول": "dezful",
        "پردیس": "pardis",
        "بابلسر": "babolsar",
        "شاهرود": "shahroud",
        "شهریار": "shahriar",
        "اندیشه": "andisheh",
        "ری": "ray",
        "پرند": "parand",
        "رباط کریم": "robatkarim",
        "بندر انزلی": "bandareanzali",
        "ساوه": "saveh",
        "بروجرد": "borujerd",
        "لواسان": "lavasan",
        "صدرا": "sadra",
        "بهارستان": "baharestan",
        "مارلیک": "marlik",
        "دماوند": "damavand",
        "ملارد": "malard",
        "گرمددره": "garmdarreh",
        "تنکابن": "tonekabon",
        "فومن": "fuman",
        "خمین": "khomein",
        "شمشک": "shemshak"
    };

    // Autocomplete for city selection
    $(function() {
      $("#city-selector").autocomplete({
        source: Object.keys(cities) // Use Persian city names for autocomplete
      });
    });

    // Load data on button click
    $("#load-button").click(function() {
		  var selectedCityPersian = $("#city-selector").val();
		  if (!selectedCityPersian) {
			alert("لطفا یک شهر انتخاب کنید");
			return;
		  }
		  
		  if (cities[selectedCityPersian]) {
			var selectedCityEnglish = cities[selectedCityPersian];
			var fileName = selectedCityEnglish + "_products.json";
			var filePath = "kalleh_products/" + fileName;

			fetch(filePath)
			  .then(response => {
				if (!response.ok) {
				  throw new Error('Network response was not ok');
				}
				return response.json();
			  })
			  .then(supermarkets => {
				addMarkers(supermarkets);
				updateProductList(supermarkets);
			  })
			  .catch(error => {
				console.error('Error loading ' + fileName + ':', error);
				alert('متاسفانه اطلاعات برای شهر ' + selectedCityPersian + ' در دسترس نمی‌باشد.');
			  });
		  } else {
			alert("شهر مورد نظر در لیست شهرهای موجود نمی‌باشد. لطفا یک شهر دیگر انتخاب کنید.");
		  }
		});

    // Search functionality
    var searchBox = document.getElementById('search-box');
    searchBox.addEventListener('input', function() {
        if (!searchBox.value) return;

        var selectedCityPersian = $("#city-selector").val();
        var selectedCityEnglish = cities[selectedCityPersian];
        var fileName = selectedCityEnglish + "_products.json";
        var filePath = "kalleh_products/" + fileName;

        fetch(filePath)
            .then(response => response.json())
            .then(supermarkets => {
                var searchTerm = searchBox.value.toLowerCase();
                var filteredSupermarkets = supermarkets.map(function(supermarket) {
                    var filteredProducts = supermarket.products.filter(function(product) {
                        return product.toLowerCase().includes(searchTerm);
                    });
                    return {
                        ...supermarket,
                        products: filteredProducts
                    };
                }).filter(function(supermarket) {
                    return supermarket.products.length > 0;
                });

                addMarkers(filteredSupermarkets);
                updateProductList(filteredSupermarkets);
            })
            .catch(error => console.error('Error loading products.json:', error));
    });
  </script>
  
  <script type="text/javascript">
    (function() {
        try {
            (function(c, l, a, r, i, t, y) {
                c[a] = c[a] || function() { (c[a].q = c[a].q || []).push(arguments); };
                t = l.createElement(r); 
                t.async = 1; 
                t.src = "https://www.clarity.ms/tag/" + i;
                y = l.getElementsByTagName(r)[0]; 
                y.parentNode.insertBefore(t, y);
            })(window, document, "clarity", "script", "po012xeaq9");
        } catch (error) {
            console.error(error);
        }
    })();
</script>

</body>
</html>